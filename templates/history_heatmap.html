<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Historique d’arrosage</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script type="module">
      import CalHeatmap from "https://cdn.skypack.dev/cal-heatmap";
      import Tooltip from "https://cdn.skypack.dev/cal-heatmap/plugins/Tooltip";

      async function loadHeatmap() {
        const response = await fetch("/api/history-heatmap");
        const rawData = await response.json();

        // Convertit les durées (en secondes) vers minutes
        const data = {};
        for (const ts in rawData) {
          data[ts] = Math.round(rawData[ts] / 60); // minutes d’arrosage
        }

        const cal = new CalHeatmap();
        cal.paint({
          itemSelector: "#cal-heatmap",
          domain: "month",
          subDomain: "day",
          range: 3,
          data: {
            source: data,
            type: "json",
          },
          scale: {
            color: {
              type: "linear",
              domain: [0, 30],
              range: ["#e0f7fa", "#006064"],
            },
          },
          tooltip: {
            enabled: true,
            plugin: Tooltip,
            options: {
              text: (date, value) => {
                return `${date.toLocaleDateString("fr-FR")} : ${
                  value || 0
                } min`;
              },
            },
          },
          date: {
            start: new Date(),
          },
        });
      }

      loadHeatmap();
    </script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/cal-heatmap@4/dist/cal-heatmap.css"
    />
    <style>
      body {
        font-family: sans-serif;
        margin: 2rem auto;
        max-width: 800px;
        padding: 1rem;
      }
      #cal-heatmap {
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <h2>Historique d’arrosage</h2>
    <p>Durée d’arrosage par jour (en minutes)</p>
    <div id="cal-heatmap"></div>
  </body>
</html>
