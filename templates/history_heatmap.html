<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Historique d’arrosage</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Cal-Heatmap CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/cal-heatmap@4.3.4/cal-heatmap.css"
    />

    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 1.5rem;
        max-width: 900px;
        margin: auto;
      }
      h2 {
        margin-bottom: 0.5rem;
      }
      #cal-heatmap {
        margin-top: 1rem;
      }
    </style>
  </head>
  <body>
    <h2>Historique des arrosages</h2>
    <p>Chaque case représente la durée d’arrosage par jour (en minutes).</p>
    <div id="cal-heatmap"></div>

    <!-- Cal-Heatmap + D3 Bundle UMD -->
    <script src="https://unpkg.com/cal-heatmap@4.3.4/dist/bundle.min.js"></script>

    <script>
      async function loadHeatmap() {
        const response = await fetch("/api/history-heatmap");
        const rawData = await response.json();

        const data = {};
        for (const ts in rawData) {
          data[ts] = Math.round(rawData[ts] / 60);
        }

        const cal = new CalHeatmap();
        cal.paint({
          itemSelector: "#cal-heatmap",
          domain: "month",
          subDomain: "day",
          range: 3,
          data: {
            source: data,
            type: "json",
          },
          scale: {
            color: {
              type: "linear",
              domain: [0, 30],
              range: ["#e0f7fa", "#006064"],
            },
          },
          date: {
            start: new Date(),
          },
          plugin: [
            Tooltip({
              text: (date, value) =>
                `${date.toLocaleDateString("fr-FR")} : ${value || 0} min`,
            }),
          ],
        });
      }

      loadHeatmap();
    </script>
  </body>
</html>
