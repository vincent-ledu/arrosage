<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Historique d’arrosage</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Cal-Heatmap CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/cal-heatmap@4.4.4/dist/cal-heatmap.css"
    />

    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 1.5rem;
        max-width: 900px;
        margin: auto;
      }
      h2 {
        margin-bottom: 0.5rem;
      }
      #cal-heatmap {
        margin-top: 1rem;
      }
    </style>

    <!-- Cal-Heatmap & Tooltip Plugin -->
    <script type="module">
      import CalHeatmap from "https://cdn.jsdelivr.net/npm/cal-heatmap@4.4.4/dist/cal-heatmap.min.js";
      import Tooltip from "https://cdn.jsdelivr.net/npm/cal-heatmap@4.4.4/dist/plugins/Tooltip.min.js";

      async function loadHeatmap() {
        try {
          const response = await fetch("/api/history-heatmap");
          const rawData = await response.json();

          // Convert durations from seconds to minutes
          const data = {};
          for (const ts in rawData) {
            data[ts] = Math.round(rawData[ts] / 60);
          }

          const cal = new CalHeatmap();
          cal.paint({
            itemSelector: "#cal-heatmap",
            domain: "month",
            subDomain: "day",
            range: 3, // Affiche 3 mois
            data: {
              source: data,
              type: "json",
            },
            scale: {
              color: {
                type: "linear",
                domain: [0, 30],
                range: ["#e0f7fa", "#006064"],
              },
            },
            date: {
              start: new Date(),
            },
            plugin: [
              Tooltip({
                text: (date, value) =>
                  `${date.toLocaleDateString("fr-FR")} : ${value || 0} min`,
              }),
            ],
          });
        } catch (error) {
          console.error("Erreur lors du chargement de la heatmap :", error);
        }
      }

      loadHeatmap();
    </script>
  </head>
  <body>
    <h2>Historique des arrosages</h2>
    <p>Chaque case représente la durée d’arrosage par jour (en minutes).</p>
    <div id="cal-heatmap"></div>
  </body>
</html>
