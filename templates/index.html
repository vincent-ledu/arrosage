<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Gestion d'Arrosage</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      body {
        font-family: sans-serif;
        padding: 20px;
        max-width: 400px;
        margin: auto;
        background-color: #f4f4f4;
      }
      h1 {
        text-align: center;
      }
      .tank {
        width: 100%;
        max-width: 300px;
        margin: 20px auto;
      }
      #water-level {
        width: 100%;
        height: auto;
      }
      input,
      button {
        width: 100%;
        padding: 10px;
        margin: 10px 0;
        font-size: 16px;
      }
      #status-info {
        text-align: center;
        font-size: 14px;
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <h1>Gestion d'Arrosage</h1>

    <div class="tank">
      <img
        id="water-level"
        src="{{ url_for('static', filename='tank_empty.png') }}"
        alt="Niveau d'eau"
      />
    </div>

    <input
      type="number"
      id="duration"
      placeholder="Durée (s)"
      min="1"
      max="300"
    />

    <button id="open-btn" onclick="startOpenWater()">Arroser</button>
    <button id="close-btn" onclick="stopOpenWater()">Arrêter l’arrosage</button>

    <div id="message"></div>
    <div id="status-info"></div>

    <script>
      let currentTaskId = null;
      let intervalCheck = null;

      async function getWaterLevel() {
        try {
          const response = await fetch("/api/check-water-level");
          const data = await response.json();
          updateTankImage(data.level);
        } catch (err) {
          console.error("Erreur récupération niveau:", err);
        }
      }

      function updateTankImage(level) {
        let image = "tank_empty.png";
        if (level > 90) image = "tank_full.png";
        else if (level > 66) image = "tank_2_3.png";
        else if (level > 33) image = "tank_1_3.png";
        else if (level > 10) image = "tank_low.png";
        document.getElementById("water-level").src = "/static/" + image;
      }

      async function startOpenWater() {
        const duration = parseInt(document.getElementById("duration").value);
        if (!duration || duration <= 0 || duration > 300) {
          alert("Durée invalide (max 300s)");
          return;
        }
        const button = document.getElementById("open-btn");
        button.disabled = true;
        document.getElementById("close-btn").disabled = false;

        const response = await fetch(`/api/open-water?duration=${duration}`);
        const data = await response.json();
        currentTaskId = data.task_id;
        checkStatus();

        intervalCheck = setInterval(() => {
          checkStatus();
        }, 30000);
      }

      async function checkStatus() {
        if (!currentTaskId) return;

        const response = await fetch(`/api/task-status/${currentTaskId}`);
        const data = await response.json();

        const statusText = {
          "en cours": "Arrosage en cours",
          terminé: "Arrosage terminé",
          annulé: "Arrosage annulé",
        };

        document.getElementById("message").textContent =
          statusText[data.status] || data.status;

        if (data.status === "en cours") {
          const now = Math.floor(Date.now() / 1000);
          const elapsed = now - Math.floor(data.start_time);
          const remaining = Math.max(0, data.duration - elapsed);

          const startTimeStr = new Date(
            data.start_time * 1000
          ).toLocaleTimeString();
          document.getElementById(
            "status-info"
          ).textContent = `Démarré à : ${startTimeStr} — Temps restant : ${remaining} sec`;
        } else {
          document.getElementById("open-btn").disabled = false;
          document.getElementById("close-btn").disabled = true;
          clearInterval(intervalCheck);
          currentTaskId = null;
          document.getElementById("status-info").textContent = "";
        }
      }

      async function stopOpenWater() {
        const response = await fetch("/api/close-water");
        const data = await response.json();
        document.getElementById("message").textContent = data.message;
        document.getElementById("open-btn").disabled = false;
        document.getElementById("close-btn").disabled = true;
        clearInterval(intervalCheck);
        document.getElementById("status-info").textContent = "";
      }

      window.onload = () => {
        document.getElementById("open-btn").disabled = false;
        document.getElementById("close-btn").disabled = true;
        getWaterLevel();
        setInterval(getWaterLevel, 30000);
      };
    </script>
  </body>
</html>
