upstream arrosage_pi {
  server unix:/run/gunicorn/gunicorn_arrosage_pi.sock;
}

# Allowlist LAN (RFC1918) - adapt to your network.
geo $remote_addr $is_lan_allowed {
  default 0;
  127.0.0.1/32 1;
  192.168.0.0/16 1;
  10.0.0.0/8 1;
  172.16.0.0/12 1;
}

server {
    listen 80;
    server_name _;

    # Health endpoints are not LAN-restricted (useful for local probes).
    location ~ ^/(healthz|healthcheck)$ {
        include proxy_params;
        proxy_pass http://arrosage_pi;
    }

    # Everything else is LAN only.
    location / {
      if ($is_lan_allowed = 0) {
        return 403;
      }
      include proxy_params;
      proxy_pass http://arrosage_pi;
    }

    error_page 403 /403.html;
    location = /403.html {
        root /usr/share/nginx/html;
        internal;
    }

    access_log /var/log/nginx/arrosage_pi_access.log;
    error_log /var/log/nginx/arrosage_pi_error.log;
}

